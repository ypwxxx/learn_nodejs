var DEBUG=!1,WSConn=function(){this._url="";this._reconnectTimeoutObj=this._serverTimeoutObj=this._heartBeatTimeoutObj=this._reconnectCallback=null;this._isReconnecting=!1;this._onOpenHandlers=[];this._onCloseHandlers=[];this._onErrorHandlers=[];this._onMessageHandlers=[];this._curReconnTime=0;this._maxReconnTime=Number.MAX_SAFE_INTEGER;this._stopReconnCallback=null;this._bCloseByUser=!1};WSConn.prototype.setDecoder=function(a){this.decoder=a;this._heartBeatMsg=a.getHeartBeatMsg()};
WSConn.prototype.heartBeatTimeOut=1E4;WSConn.prototype.getReadyState=function(){return this.ws?this.ws.readyState:0};WSConn.prototype._clearHeartBeat=function(){this._heartBeatTimeoutObj&&clearTimeout(this._heartBeatTimeoutObj);this._serverTimeoutObj&&clearTimeout(this._serverTimeoutObj)};
WSConn.prototype._startHeartBeat=function(){var a=this;this._heartBeatTimeoutObj=setTimeout(function(){DEBUG&&console.log("send heartBeat "+(new Date).getTime());a.send(a._heartBeatMsg);a._serverTimeoutObj=setTimeout(function(){a._isReconnecting||(a._initForReconnect(),a._handleReconnect())},a.heartBeatTimeOut)},this.heartBeatTimeOut)};
WSConn.prototype.connect=function(a){if(!a)return console.error("url is null"),null;this._url=a;this.ws=new WebSocket(a);this.ws.binaryType="arraybuffer";this._addInitCallback();DEBUG&&console.log("request socket success");return this};WSConn.prototype._clearReconnect=function(){this._reconnectTimeoutObj&&clearTimeout(this._reconnectTimeoutObj);this._isReconnecting=!1;this._curReconnTime=0};
WSConn.prototype._addInitCallback=function(){var a=this;this.ws.addEventListener("open",function(){DEBUG&&console.log("connection open");a._clearReconnect();a._startHeartBeat()});this.ws.addEventListener("message",function(b){a._clearHeartBeat();a._startHeartBeat()});this.ws.addEventListener("close",function(b){a._bCloseByUser?DEBUG&&console.log("connection close"):a._isReconnecting||(console.warn("connection close abnormally, need reconnect"),a._initForReconnect(),a._handleReconnect())});this.ws.addEventListener("error",
function(a){console.warn("connection error")})};WSConn.prototype._addTransCallback=function(){for(var a=0;a<this._onOpenHandlers.length;a++)this.ws.addEventListener("open",this._onOpenHandlers[a]);for(a=0;a<this._onCloseHandlers.length;a++)this.ws.addEventListener("close",this._onCloseHandlers[a]);for(a=0;a<this._onErrorHandlers.length;a++)this.ws.addEventListener("error",this._onErrorHandlers[a]);for(a=0;a<this._onMessageHandlers.length;a++)this.ws.addEventListener("message",this._onMessageHandlers[a])};
WSConn.prototype._handleReconnect=function(){this.ws&&(this.ws.close(),this.ws=null);if(this._curReconnTime>=this._maxReconnTime&&this._stopReconnCallback)console.log("reconnect more than "+this._maxReconnTime+" times, stop reconnect"),this._stopReconnCallback(),this._curReconnTime=0;else{var a=this;this.connect(this._url);this._curReconnTime++;this._addTransCallback();DEBUG&&console.log("reconnect state = "+a.ws.readyState);a._reconnectTimeoutObj=setTimeout(function(){console.error("auto reconnect fail");
a._handleReconnect()},5E3)}};WSConn.prototype._initForReconnect=function(){DEBUG&&console.log("init for reconnect");this._isReconnecting=!0;this._curReconnTime=0;this._reconnectCallback&&this._reconnectCallback();this._clearHeartBeat()};
WSConn.prototype.close=function(){console.log("close by user");this.ws&&(this.ws.close(),this.ws=null);this._clearHeartBeat();clearTimeout(this._reconnectTimeoutObj);this._onOpenHandlers.length=0;this._onCloseHandlers.length=0;this._onErrorHandlers.length=0;this._onMessageHandlers.length=0;this._bCloseByUser=!0};WSConn.prototype.onOpen=function(a){if(a&&"function"===typeof a){var b=function(b){a(b)};this.ws.addEventListener("open",b);this._onOpenHandlers.push(b)}};
WSConn.prototype.onClose=function(a){if(a&&"function"===typeof a){var b=function(b){a(b)};this.ws.addEventListener("close",b);this._onCloseHandlers.push(b)}};WSConn.prototype.onError=function(a){if(a&&"function"===typeof a){var b=function(b){a(b)};this.ws.addEventListener("error",b);this._onErrorHandlers.push(b)}};
WSConn.prototype.onMessage=function(a){var b=this;if(a&&"function"===typeof a){var c=function(c){"error"==c.type?console.warn("receive message type=error"):(c=b.decoder.deserialize(c.data))&&c.cmdType!=b._heartBeatMsg.cmdType&&a(c)};this.ws.addEventListener("message",c);this._onMessageHandlers.push(c)}};WSConn.prototype.setReconnectOptions=function(a,b,c){a&&"function"===typeof a&&(this._reconnectCallback=a);0<b&&(this._maxReconnTime=b);c&&"function"===typeof c&&(this._stopReconnCallback=c)};
WSConn.prototype.send=function(a){if(a=this.decoder.serialize(a))if(4>a.byteLength)console.error("buffer len < 4, stop send message");else{var b=this.getReadyState();1==b?this.ws.send(a):console.error("ready state is "+b+",stop send message")}else console.warn("stop send nothing")};var WXWSConn=function(a){WSConn.call(this,a)};WXWSConn.prototype=new WSConn;
WXWSConn.prototype.connect=function(a){if(!a)return console.error("url is null"),null;this._url=a;this.ws=wx.connectSocket({url:a,success:function(){DEBUG&&console.log("request websocket success")},fail:function(){console.error("request websocket fail")}});this._addInitCallback();return this};
WXWSConn.prototype._addTransCallback=function(){for(var a=0;a<this._onOpenHandlers.length;a++)this.ws.onOpen(this._onOpenHandlers[a]);for(a=0;a<this._onCloseHandlers.length;a++)this.ws.onClose(this._onCloseHandlers[a]);for(a=0;a<this._onErrorHandlers.length;a++)this.ws.onError(this._onErrorHandlers[a]);for(a=0;a<this._onMessageHandlers.length;a++)this.ws.onMessage(this._onMessageHandlers[a])};
WXWSConn.prototype._addInitCallback=function(){var a=this;this.ws.onOpen(function(b){DEBUG&&console.log("connection open");a._clearReconnect();a._startHeartBeat()});this.ws.onClose(function(b){a._bCloseByUser?DEBUG&&console.log("connection close"):a._isReconnecting||(console.warn("connection close abnormally, need reconnect"),a._initForReconnect(),a._handleReconnect())});this.ws.onError(function(a){console.warn("connection error")});this.ws.onMessage(function(b){DEBUG&&console.log("receive message");
a._clearHeartBeat();a._startHeartBeat()})};WXWSConn.prototype.onOpen=function(a){if(a&&"function"===typeof a){var b=function(b){a(b)};this.ws.onOpen(b);this._onOpenHandlers.push(b)}};WXWSConn.prototype.onClose=function(a){if(a&&"function"===typeof a){var b=function(b){a(b)};this.ws.onClose(b);this._onCloseHandlers.push(b)}};WXWSConn.prototype.onError=function(a){if(a&&"function"===typeof a){var b=function(b){a(b)};this.ws.onError(b);this._onErrorHandlers.push(b)}};
WXWSConn.prototype.onMessage=function(a){var b=this;if(a&&"function"===typeof a){var c=function(c){(c=b.decoder.deserialize(c.data))&&c.cmdType!=b._heartBeatMsg.cmdType?a&&"function"===typeof a&&a(c):DEBUG&&console.log("return message:"+JSON.stringify(c))};this.ws.onMessage(c);this._onMessageHandlers.push(c)}};
WXWSConn.prototype.send=function(a){if(a=this.decoder.serialize(a))if(4>a.byteLength)console.error("buffer len < 4, stop send message");else{var b=this.getReadyState();1==b?this.ws.send({data:a,success:function(){DEBUG&&console.log("send success")},fail:function(a){console.error("send fail:"+JSON.stringify(a))}}):console.error("ready state is "+b+",stop send message")}else console.warn("stop send nothing")};
var WSClient={connect:function(a,b){var c=!1;try{wx&&wx.getSystemInfoSync&&(c=!0)}catch(d){}if(!b)return console.error("decoder is null"),null;if(!b.getHeartBeatMsg||!b.getHeartBeatMsg())return console.error("decoder.getHeartBeatMsg is null"),null;if(!b.serialize)return console.error("decoder.serialize is null"),null;if(!b.deserialize)return console.error("decoder.deserialize is null"),null;if(!a)return console.error("url is null"),null;c=c?new WXWSConn:new WSConn;c.setDecoder(b);return c.connect(a)}};
module.exports=WSClient;